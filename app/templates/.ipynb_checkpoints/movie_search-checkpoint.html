{% extends "base.html" %}
{% block content %}
<div class="bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center">Search Movies</h2>
    <form id="search-form" class="mb-8 flex items-center space-x-4" onsubmit="return false;">
        <input type="text" id="search-input" name="search_term" placeholder="Enter movie title..."
               value="{{ search_term if search_term is defined else '' }}"
               class="flex-grow shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
    </form>

    <div id="loading-indicator" class="text-center text-gray-600 hidden">
        <p>Searching...</p>
        <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto mt-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l1-2.647z"></path>
        </svg>
    </div>

    <div id="search-results-container" class="overflow-x-auto">
        <!-- Search results table will be dynamically inserted here -->
    </div>
</div>

<script>
    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    let timeoutId;

    async function fetchAndRenderResults(searchTerm) {
        if (!searchTerm) {
            resultsContainer.innerHTML = ''; // Clear results if search term is empty
            return;
        }
        
        loadingIndicator.classList.remove('hidden');

        try {
            const url = `{{ url_for('search_movies') }}?search_term=${encodeURIComponent(searchTerm)}`;
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            
            const data = await response.json();

            resultsContainer.innerHTML = ''; // Clear previous results

            if (data.error) {
                resultsContainer.innerHTML = `<p class="text-center text-red-500 mt-4">${data.error}</p>`;
            } else if (data.length > 0) {
                const tableHtml = `
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 border-b border-gray-200">Title</th>
                                <th class="py-3 px-6 border-b border-gray-200">Year</th>
                                <th class="py-3 px-6 border-b border-gray-200">Summary</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm">
                            ${data.map(movie => `
                                <tr class="border-b border-gray-200 hover:bg-gray-50">
                                    <td class="py-3 px-6 font-medium">${movie.title}</td>
                                    <td class="py-3 px-6">${movie.year || 'N/A'}</td>
                                    <td class="py-3 px-6 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${movie.summary || 'No summary available.'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                resultsContainer.innerHTML = tableHtml;
            } else {
                resultsContainer.innerHTML = `<p class="text-center text-gray-600 mt-4">No movies found matching "${searchTerm}".</p>`;
            }
        } catch (error) {
            console.error('Error fetching search results:', error);
            resultsContainer.innerHTML = `<p class="text-center text-red-500 mt-4">Failed to load search results.</p>`;
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    searchInput.addEventListener('keyup', function() {
        clearTimeout(timeoutId); // Clear the previous timer
        const searchTerm = searchInput.value.trim();
        if (searchTerm.length >= 3) { // Start searching after 3 characters
            loadingIndicator.classList.remove('hidden');
            timeoutId = setTimeout(() => {
                fetchAndRenderResults(searchTerm);
            }, 300); // 300ms delay to avoid spamming the server
        } else {
            resultsContainer.innerHTML = '';
        }
    });

    // Initial check on page load to display any pre-existing results
    if (searchInput.value.trim()) {
        fetchAndRenderResults(searchInput.value.trim());
    }
</script>
{% endblock %}
