{% extends "base.html" %}
{% block content %}
<div class="bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center">All Plex Content</h2>

    <!-- Filtering and Sorting Controls -->
    <div class="mb-8 flex flex-col space-y-4 md:flex-row md:space-x-6 md:space-y-0 items-center justify-between">
        <!-- Filter Form -->
        <form id="filter-form" method="GET" action="{{ url_for('list_all_content') }}" class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 w-full">
            <select name="genre" class="w-full md:w-auto px-4 py-2 border rounded-md">
                <option value="">All Genres</option>
                {% for genre in genres %}
                    <option value="{{ genre }}" {% if selected_genre == genre %}selected{% endif %}>{{ genre }}</option>
                {% endfor %}
            </select>
            <select name="year" class="w-full md:w-auto px-4 py-2 border rounded-md">
                <option value="">All Years</option>
                {% for year in years %}
                    <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
            <select name="rating" class="w-full md:w-auto px-4 py-2 border rounded-md">
                <option value="">All Ratings</option>
                {% for rating in ratings %}
                    <option value="{{ rating }}" {% if selected_rating == rating %}selected{% endif %}>{{ rating }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="w-full md:w-auto px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Filter</button>
        </form>
    </div>

    {% if content_list %}
    <div class="overflow-x-auto">
        <table id="content-table" class="min-w-full bg-white border border-gray-200 rounded-lg">
            <thead>
                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 border-b border-gray-200 cursor-pointer" onclick="sortTable('type')">
                        Type
                        {% if sort_by == 'type' %}
                            {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </th>
                    <th class="py-3 px-6 border-b border-gray-200 cursor-pointer" onclick="sortTable('title')">
                        Title
                        {% if sort_by == 'title' %}
                            {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </th>
                    <th class="py-3 px-6 border-b border-gray-200 cursor-pointer" onclick="sortTable('year')">
                        Year
                        {% if sort_by == 'year' %}
                            {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </th>
                    <th class="py-3 px-6 border-b border-gray-200">Summary</th>
                </tr>
            </thead>
            <tbody id="content-table-body" class="text-gray-700 text-sm">
                <!-- Content rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-gray-600">No content found or an error occurred.</p>
    {% endif %}
    
    <!-- Loading indicator for infinite scroll -->
    <div id="loading-indicator" class="text-center py-4 text-gray-600 hidden">
        <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l1-2.647z"></path>
        </svg>
    </div>
    <div id="end-of-list" class="text-center py-4 text-gray-600 hidden">
        <p>You've reached the end of the content list.</p>
    </div>
</div>

<script>
    let page = 1;
    const limit = 50;
    let loading = false;
    let allDataLoaded = false;
    
    const tableBody = document.getElementById('content-table-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endOfList = document.getElementById('end-of-list');

    function sortTable(sortBy) {
        const url = new URL(window.location.href);
        let sortOrder = url.searchParams.get('sort_order');
        let currentSortBy = url.searchParams.get('sort_by');

        if (currentSortBy === sortBy) {
            sortOrder = (sortOrder === 'asc') ? 'desc' : 'asc';
        } else {
            sortOrder = 'asc';
        }

        url.searchParams.set('sort_by', sortBy);
        url.searchParams.set('sort_order', sortOrder);
        // Reset page to 1 when a new sort is applied
        url.searchParams.set('page', 1);
        window.location.href = url.href;
    }

    async function fetchDataAndAppend() {
        if (loading || allDataLoaded) return;

        loading = true;
        loadingIndicator.classList.remove('hidden');

        try {
            const url = new URL("{{ url_for('list_all_content') }}", window.location.origin);
            url.searchParams.set('page', page);
            url.searchParams.set('limit', limit);
            // Append any existing filters to the new URL
            const filterForm = document.getElementById('filter-form');
            new URLSearchParams(new FormData(filterForm)).forEach((value, key) => {
                if (value) url.searchParams.set(key, value);
            });
            url.searchParams.set('sort_by', document.querySelector('th[onclick*="sortTable"]').textContent.trim().toLowerCase());
            url.searchParams.set('sort_order', 'asc'); // Assuming default sort order is asc

            const response = await fetch(url);
            const data = await response.json();

            if (data.error) {
                console.error("API Error:", data.error);
                allDataLoaded = true;
                endOfList.textContent = `Error: ${data.error}`;
                endOfList.classList.remove('hidden');
                return;
            }

            if (data.length === 0) {
                allDataLoaded = true;
                endOfList.classList.remove('hidden');
            } else {
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-6">${item.type}</td>
                        <td class="py-3 px-6 font-medium">${item.title}</td>
                        <td class="py-3 px-6">${item.year || 'N/A'}</td>
                        <td class="py-3 px-6 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${item.summary || 'No summary available.'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                page++;
            }
        } catch (e) {
            console.error('Failed to fetch content:', e);
            allDataLoaded = true;
            endOfList.textContent = 'Failed to load content.';
            endOfList.classList.remove('hidden');
        } finally {
            loading = false;
            loadingIndicator.classList.add('hidden');
        }
    }

    // Initial fetch
    fetchDataAndAppend();

    // Infinite scroll event listener
    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            fetchDataAndAppend();
        }
    });

    // Handle filter form submission
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        page = 1;
        allDataLoaded = false;
        tableBody.innerHTML = '';
        fetchDataAndAppend();
    });

    // Handle initial sort parameter
    document.querySelectorAll('th[onclick*="sortTable"]').forEach(header => {
        const url = new URL(window.location.href);
        if (header.textContent.trim().toLowerCase() === url.searchParams.get('sort_by')) {
            const sortOrder = url.searchParams.get('sort_order');
            header.innerHTML += (sortOrder === 'asc') ? '▲' : '▼';
        }
    });
</script>
{% endblock %}
